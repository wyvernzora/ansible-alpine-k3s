---
# Add boot flags required by Rancher/K3S;
# See https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup
- name: bootstrap/alpine | Add boot args required by rancher/k3s
  lineinfile:
    path: /etc/update-extlinux.conf
    search_string: 'default_kernel_opts="quiet rootfstype=ext4"'
    line: 'default_kernel_opts="quiet rootfstype=ext4 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory"'
  register: bootargs

- name: bootstrap/alpine | Update bootloader
  shell:
    cmd: update-extlinux
  when: bootargs.changed

- name: bootstrap/alpine | Reboot
  reboot:
  when: bootargs.changed

- name: bootstrap/alpine | Enable cgroup service
  service:
    name: cgroups
    enabled: yes
    state: started
    runlevel: boot

- name: bootstrap/alpine | Configure timezone
  timezone:
    name: "{{ timezone }}"
  when: (timezone is defined) and (timezone != "Your/Timezone")

- name: bootstrap/alpine | Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: yes

- name: bootstrap/alpine | Enable IPv6 forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    state: present
    reload: yes
